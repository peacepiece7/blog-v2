# 터보레포 리포지토리 구조화

터보레포(Turborepo)는 JavaScript 생태계의 패키지 관리자의 기능인 워크스페이스를 기반으로 구축된 빌드 시스템입니다. 이를 통해 여러 패키지를 하나의 리포지토리로 그룹화할 수 있습니다.

## 주요 내용 요약

1. **워크스페이스 설정**:

   - 워크스페이스는 단일 패키지 또는 다중 패키지로 구성될 수 있습니다.
   - `create-turbo` 명령어를 사용하여 유효한 워크스페이스 구조를 신속하게 설정할 수 있습니다.

2. **필수 파일 및 디렉토리**:

   - 루트 디렉토리에 `package.json`, `turbo.json`, 및 패키지 관리자 잠금 파일이 필요합니다.
   - 패키지 디렉토리는 `apps/`와 `packages/`로 구분하여 각 디렉토리에 패키지별 `package.json` 파일이 있어야 합니다.

3. **패키지 구성 요소**:

   - 각 패키지는 고유한 이름과 스크립트를 가지며, 다른 패키지에서 접근할 수 있는 엔트리 포인트를 지정합니다.
   - `exports` 필드를 사용하여 패키지 내 모듈의 엔트리 포인트를 지정할 수 있으며, 이는 IDE 자동 완성을 돕습니다.

4. **공통 실수 방지**:
   - TypeScript를 사용하는 경우, 각 패키지는 자체 `tsconfig.json` 파일을 지정해야 하며, 루트 워크스페이스에는 필요하지 않습니다.
   - 패키지 간 파일 접근을 피하고, **필요한 패키지를 설치하여 코드에 임포트하는 방식을 사용해야 합니다.**

> 추가 설명
> packages, app으로 폴더를 나눔  
> packages안에는 글자 그대로 패키지 단위 configuration, ui design, module 등을 작성  
> apps은 모바일, 웹 등 어플리케이션으로 나눔  
> 각 package, app 안에는 package.json이 있고 그 안에서 쓰고싶은 패키지를 명시해주면 됨..!

## 링크

https://turbo.build/repo/docs/crafting-your-repository/structuring-a-repository

# 터보레포 의존성 관리

터보레포(Turborepo)는 JavaScript 생태계의 패키지 관리자의 기능인 워크스페이스를 기반으로 구축된 빌드 시스템입니다. 이를 통해 외부 및 내부 의존성을 효과적으로 관리할 수 있습니다.

```json
{
  "dependencies": {
    "next": "latest", // External dependency
    "@repo/ui": "*" // Internal dependency
  }
}
```

## 주요 내용 요약

1 **의존성 설치 원칙**:

- **의존성은 해당 패키지에서 사용될 때 직접 설치해야 합니다**.
- 패키지의 `package.json` 파일에 모든 의존성을 나열하여 명확성을 높이고, 팀 간 유연성을 유지할 수 있습니다.
- 루트 디렉토리에는 리포지토리 관리를 위한 도구만 설치하고, 응용 프로그램 및 라이브러리 빌드를 위한 의존성은 각 패키지에 설치합니다.

> 중요하니까 추가 설명!
>
> 만약 jest를 `web`, `@repo/ui` 패키지에 설치한다면 (package.json의 name 필드가 `web`, `@repo/ui`임) 다음과 같이 설치
>
> ```bash
> $ pnpm
> pnpm install jest --save-dev --recursive --filter=web --filter=@repo/ui --filter=@repo/web
> $ npm
> npm install jest --workspace=web --workspace=@repo/ui --save-dev
> ```
>
> 이렇게 하는 이유는 보통 operation scale이나 timeline, requirments, priority가 패키지 마다 다르기 떄문

## 링크

https://turbo.build/repo/docs/crafting-your-repository/managing-dependencies

# 내부 패키지 생성 | 터보레포

packages/math와 apps/web가 있을 때 packages/math를 import해보자

packages/math/package.json은 다음과 같다.

```json
{
  "name": "@repo/math",
  "type": "module",
  "scripts": {
    "dev": "tsc --watch",
    "build": "tsc"
  },
  "exports": {
    "./add": {
      "types": "./src/add.ts",
      "default": "./dist/add.js"
    },
    "./subtract": {
      "types": "./src/subtract.ts",
      "default": "./dist/subtract.js"
    }
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*",
    "typescript": "latest"
  }
}
```

apps/web에서는 다음과 같이 추가한다.

apps/web/package.json

```json
  "dependencies": {
+   "@repo/math": "workspace:*",
    "next": "latest",
    "react": "latest",
    "react-dom": "latest"
  },
```

`pnpm install`을 실행해서 lockfile을 업데이트한다.

## turbo.json 캐싱

@repo/math의 결과를 캐시하려면 outputs에 dist/\*\* 추가해준다.

```json
{
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
    }
  }
}
```

## 링크

https://turbo.build/repo/docs/crafting-your-repository/creating-an-internal-package

# 작업 구성 | 터보레포

터보레포(Turborepo)는 `turbo.json` 구성과 패키지 그래프에 설명된 순서에 따라 작업을 실행하며, **가능한 경우 작업을 병렬 처리**하여 모든 작업을 최대한 빠르게 완료합니다.

## 주요 내용 요약

1 **작업 정의**:

- `turbo.json` 파일의 `tasks` 객체에 작업을 정의합니다.
- 각 작업 키는 `turbo run`으로 실행할 수 있는 작업을 나타내며, 패키지의 `package.json`에서 동일한 이름의 스크립트를 검색합니다.
- 예시:
  ```json
  {
    "tasks": {
      "build": {
        "dependsOn": ["^build"],
        "outputs": [".next/**", "!.next/cache/**"]
      }
    }
  }
  ```

2 **작업 순서 지정**:

- `dependsOn` 키를 사용하여 다른 작업이 시작되기 전에 완료해야 하는 작업을 지정합니다.
- `^` 마이크로 구문을 사용하여 의존성 그래프의 최하위부터 작업을 실행할 수 있습니다.
- 예시:
  ```json
  {
    "tasks": {
      "lint": {
        "dependsOn": ["^build"]
      }
    }
  }
  ```

> ! 작업 순서 요약  
> 작업 순서는 중요하고 복잡한 점이 있어서 다시 요약합니다.

**TL;DR**

- `^` : 빌드시 사용한다.
- "dependsOn" 만 있을 경우 : 테스트시 사용한다.
- "dependsOn" + `#` : 문법검사(lint, type 체크)시 사용한다.
- "아무것도 없음" : 단어 검사(굳이 틀려도 상관없는 warrnning)시 사용한다.

### dependsOn

"dependsOn" 키는 다른 작업이 시작되기 전에 완료해야 하는 작업을 지정하는 데 사용됩니다.

**빌드 전 테스트를 실행합니다.**

**실행 순서 : "build" => "test"**

```json
{
  "tasks": {
    "test": {
      "dependsOn": ["build"]
    }
  }
}
```

### "^" 키워드

`^`는 모든 하위 종속부터 순차적으로 실행됩니다.

라이브러리가 빌드 되기 전에 패키지를 빌드하고 싶어하는 사람은 드물기 때문에 이런 경우 사용합니다.

**빌드 전 최하위 라이브러리부터 빌드합니다.**

**실행 순서 : "dependsOn ^build" => "build"**

```json
{
  "tasks": {
    "build": {
      "dependsOn": ["^build"]
    }
  }
}
```

### "#" 키워드

`#`는 개별 패키지를 지칭하는데 쓰입니다. `<package>#<script>` 형식으로 `math#build`, `@repo/util#build`와 같이 씁니다.

린트 작업을 수정하기 전에 린트와 관련된 패키지를 미리 빌드하는 경우 사용합니다.

**린트 실행 전 util 패키지의 build 스크립트를 실행합니다.**

**실행 순서 : utils 패키지의 "build" => "lint"**

```json
{
  "tasks": {
    "lint": {
      "dependsOn": ["utils#build"]
    }
  }
}
```

특정 패키지로 제한 할 수 있습니다.

```json
{
  "web#tasks": {
    "lint": {
      "dependsOn": ["utils#build"]
    }
  }
}
```

### 아무것도 없는 경우

dependsOn이 없거나 빈 배열이면 의존성이 없는 작업입니다.

```json
{
  "tasks": {
    "spell-check": {
      "dependsOn": []
    }
  }
}
```

---

3 **출력 및 입력 지정**:

- `outputs` 키는 작업이 성공적으로 완료되었을 때 캐시해야 하는 파일과 디렉터리를 지정합니다.
- `inputs` 키는 캐싱을 위한 작업 해시의 파일을 지정합니다. 기본적으로 Turborepo는 Git에서 추적된 모든 파일을 포함합니다.
- 예시:
  ```json
  {
    "tasks": {
      "spell-check": {
        "inputs": ["**/*.md", "**/*.mdx"]
      }
    }
  }
  ```

4 **루트 작업 등록**:

- 워크스페이스 루트의 `package.json`에서 스크립트를 실행하기 위해 루트 작업을 등록할 수 있습니다.
- 예시:
  ```json
  {
    "tasks": {
      "lint": {
        "dependsOn": ["^lint"]
      },
      "lint:root": {}
    }
  }
  ```

5 **고급 사용 사례**:

- 패키지 구성: 패키지별로 `turbo.json` 파일을 사용하여 개별 작업을 정의할 수 있습니다.
- 사이드 이펙트 수행: 특정 작업은 항상 실행되어야 하므로 `cache: false`를 추가하여 설정합니다.
- 예시:
  ```json
  {
    "tasks": {
      "deploy": {
        "dependsOn": ["^build"],
        "cache": false
      },
      "build": {
        "outputs": ["dist/**"]
      }
    }
  }
  ```
